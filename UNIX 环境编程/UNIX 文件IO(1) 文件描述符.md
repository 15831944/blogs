# 1. 文件描述符概述

内核（kernel）利用文件描述符（file descriptor）来访问打开的文件(或 socket)。

当程序打开现存文件或新建文件时，内核会返回一个文件描述符。 因此文件描述符与打开的文件个数是相同的。

读写文件也需要使用文件描述符来指定待读写的文件。

文件描述符在形式上是一个非负整数。实际上，它是一个索引值，指向内核为每一个进程所维护的该进程的打开文件的文件表项。

在程序设计中，一些涉及底层的程序编写往往会围绕着文件描述符展开。

文件描述符这一概念只适用于 UNIX 操作系统 (因为 windows 用句柄?).

文件描述符的变化范围是 0 到 OPEN_MAX - 1。

对于进程, 每个进程最多可以打开 64 个文件（0 — 63）。

对于 FreeBSD 8.0、Linux 3.2.0、Mac OS X 10.6.8 和 Solaris 10 来说，每个进程最多可以打开文件的多少取决于系统配置的存储器总量，int 的大小以及系统管理员所配置的软限制和硬限制的约束。

Linux 2.4.22 强制规定文件描述符大小最多不能超过 1,048,576 (0010,0000H 或 2^20)。

文件描述符与包括相关信息（如文件的打开模式、文件的位置类型、文件的初始类型等）的文件对象相关联，这些信息被称作文件的上下文。

# 2. 文件描述符常量

| 进程 | 文件描述符 | POSIX.1 在 unistd.h 中宏定义 | 标准I/O流 |
| ----------------------------- | - | ------------- | ------ |
| 进程的标准输入（standard input） | 0 | STDIN_FILENO  | stdin  |
| 进程的标准输出（standard output）| 1 | STDOUT_FILENO | stdout |
| 进程的标准错误（standard error） | 2 | STDERR_FILENO | stderr |

# 3. 创建文件描述符

进程获取文件描述符最常见的方法:

1. 通过本机的子例程 open 或 create 函数获取

2. 通过从父进程继承, 允许子进程能够访问由父进程使用的文件

文件描述符对于每个进程是唯一的, 存放于各进程的进程表项.

当用 fork 子例程创建某个子进程时，该子进程会获得其父进程所有文件描述符的副本，这些文件描述符在执行 fork 时打开。

在由 fcntl、dup 和 dup2 子例程复制或拷贝某个进程时，会发生同样的复制过程。

对于每个进程，操作系统内核在 u_block 结构中维护文件描述符表，所有的文件描述符都在该表中建立索引。

# 4. 文件描述符硬限制

## 1. 系统级限制

为防止打开的文件占用过多系统内存，一般设置最大打开文件数是系统内存的10%

### 配置文件

`/proc/sys/fs/file-max`

### 说明

1. 用 `sysctl -a | grep fs.file-max` 命令查看查看系统级别的最大打开文件数

## 2. 用户进程限制

为了防止单个进程消耗掉所有的文件资源，限制单个进程的最大打开文件数

### 配置文件

`/etc/security/limits.conf`

例如要设置用户 username 的一个进程可最大打开的文件数为2048，在该文件里新增加一行：

`username hard nofile 2048`

保存该文件并退出, 该用户要重新登录系统，设置才会生效。

### 说明

1. 在这里设置的数字，不能超过`/proc/sys/fs/file-max`里面的数字。即便超过也没用。因为 file-max 里面限制了整个系统能同时打开的文件的数目。

2. 在 `/etc/security/limits.conf` 文件里还可以针对用户设置其他资源的限制。

3. 用 `ulimit -n` 可查看当前用户在一个进程内可同时打开的文件数目。如 1024

# 5. 文件描述符标志

执行时关闭标志 close-on-exec(仅此一个)

FDCLOEXEC

| 值 | 说明 |
| - | - |
| 0 | exec 时不关闭已经打开的文件描述符(默认) |
| 1 | exec 时关闭已经打开的文件描述符        |

## 1. exec 函数集对文件描述符标志的影响

1. 对打开文件的处理与每个描述符的执行时关闭标志的值有关
2. 进程中每个打开描述符都有一个执行时关闭标志
3. 若此标志设置，则在执行exec时关闭该描述符，否则该描述符仍打开
4. 除非特地用fcntl设置了该标志，否则系统的默认操作是在exec后仍保持这种描述符打开。
5. POSIX.1明确要求在exec时关闭打开目录流, 这通常是由 opendir 函数实现的，它调用fcntl函数为对应于打开目录流的描述符设置执行时关闭标志


## 2. dup 函数对文件描述符标志的影响

新文件描述符的执行时关闭标志总是由 dup 函数清除
  
  
## 3. fcntl 函数既能改变文件描述符标志，也能改变文件状态标志

| 命令 | 说明 |
| - | - |
| FGETFD | 获取文件描述符标志 |
| FSETFD | 设置文件描述符标志 |
| FGETFL | 获取文件状态标志 |
| FSETFL | 设置文件状态标志 |


# 参考

[文件描述符标志和文件状态标志区别](http://blog.csdn.net/hittata/article/details/8665892)

[每天进步一点点——Linux中的文件描述符与打开文件之间的关系](http://blog.csdn.net/cywosp/article/details/38965239)
