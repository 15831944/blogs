# select 函数

1. select() 函数用于确定一个或多个套接口的状态
2. 对每一个套接口, 调用者可查询它的可读性、可写性及错误状态信息
3. 用fd_set结构来表示一组等待检查的套接口, 在调用返回时, 这个结构存有满足一定条件的套接口组的子集, 并且select()返回满足条件的套接口的数目。
4. 有一组宏可用于对fd_set的操作, 这些宏与Berkeley Unix软件中的兼容, 但内部的表达是完全不同的。

# 文件描述符集

1. select 机制中提供了一个数据结构 `struct fd_set`, 可以理解为一个集合, 实际上是一个位图, 每一个特定位来标志相应大小文件描述符
2. 文件描述符集存放的是 socket 文件描述符(文件句柄), 也就是位图上的每一位都能与一个打开的文件描述符建立联系, 这个工作由程序员来完成
3. UNIX 下任何设备, 管道, FIFO 等都是文件形式, 所以 socket 也是一个文件, socket 句柄就是一个文件描述符

fd_set 集合可以通过4个宏来人为来操作

```
FD_ZERO(fd_set *)		// 清空指定文件描述符集合
FD_SET(int, fd_set *)	// 将指定文件描述符添加到指定文件描述符集合中
FD_CLR(int, fd_set *)	// 将指定文件描述符从集合中删除
FD_ISSET(int, fd_set *)	// 检查集合中指定的文件描述符是否可以读写
```

理解 select 模型的关键点在于理解 fd_set, 为了说明方便, 我们取 fd_set 长度为1个字节, fd_set 中的每一个 bit 可以对应一个文件描述符 fd, 则1字节长的 fd_set 最大可以对应8个 fd

```
fd_set set;
FD_ZERO(&set);				// set 用位表示为 0000,0000
FD_SET(fd, &set);			// 若 fd = 5, 则 set 变为 0001,0000
FD_SET(fd, &set);			// 若 fd = 1, 则 set 变为 0001,0001
FD_SET(fd, &set);			// 若 fd = 2, 则 set 变为 0001,0011
select(6, &set, 0, 0, 0);	// 阻塞等待, 若 fd = 1, fd = 2 上都发生可读事件, 则 select 返回, 此时 set 变为 0000, 0011, 没有可读事件发生时 fd = 5 被清空
```


```
int select(int maxfdp, fd_set *readfds, fd_set *writefds, fd_set *errorfds, struct timeval *timeout); 
```

函数参数

1. maxfdp 是集合中所有文件描述符的范围, 即文件描述符最大值加1, 定义了文件描述符这个位图中有效的位的个数
2. readfds 是指向 fd_set 结构的指针, 这个集合中应该包括文件描述符, 我们是要监视这些文件描述符的读变化的, 即我们关心是否可以从这些文件中读取数据了, 如果这个集合中有一个文件可读, select 就会返回一个大于0的值, 表示有文件可读; 如果没有可读的文件, 则根据 timeout 参数再判断是否超时, 若超出 timeout 的时间, select 返回0, 若发生错误返回负值, 可以传入 NULL 值, 表示不关心任何文件的读变化
3. writefds 同理, 用来监视写变化文件
4. errorfds 同理, 用来监视错误异常文件
5. timeout 是 select 函数的超时时间, 可以使 select 处于3种状态

函数超时

1. 若传入 NULL, 即不传入时间结构, 则 select 函数置于阻塞状态, 一定等到监视文件描述符集合中某个文件描述符发生变化为止
2. 若传入 timeout 的值为0秒0毫秒, 则 select 函数变成一个非阻塞函数, 不管文件描述符是否有变化, 都立刻返回继续执行, 文件无变化则返回0, 文件有变化则返回一个正值
3. 若传入 timeout 的值大于0, 即函数等待的超时时间, select 函数在 timeout 时间内阻塞, 超时时间之内有事件到来就返回, 否则在超时后不轮是否有事件到来都返回, 返回值同上

函数返回

1. 当监视的相应的文件描述符集中满足条件时, 比如说读文件描述符集中有数据到来时, 内核(I/O)根据状态修改文件描述符集, 并返回一个大于0的数
2. 当没有满足条件的文件描述符且超时时, select 函数会返回0
3. 当发生错误时, select 函数返回负值

参考

1. [select函数详解及实例分析](http://blog.csdn.net/leo115/article/details/8097143)
2. select函数的一些参考解析：http://www.groad.net/bbs/read.php?tid-1064.html
3. select函数与pselect函数的区别参考：http://hi.baidu.com/_jiangming/item/56d5c43fe2cadb4981f1a789
4. pselect函数是一个 防止信号干扰的增强型 select函数
5. http://blog.csdn.NET/s_k_yliu/article/details/6642645
6. http://blog.chinaunix.net/uid-26851094-id-3175153.html
7. http://baike.baidu.com/view/3421856.htm
