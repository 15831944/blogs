# SPI 概述

SPI(Serial Peripheral Interface, 串行外围接口)是 Motorola 公司提出的一种同步串行数据传输标准, 是一种高速, 全双工, 同步的通信总线, 在很多器件中被广泛应用

1. SPI 是一个环形总线结构，在 sck 产的生时钟信号的控制下，两个双向移位寄存器进行数据交换
2. 读写操作实际上完成的都是数据的交换, 即主机传送1个字节给从机(写)的同时, 从机会传送1个字节给主机(读)
3. 数据是一边发送一边接收, 你想接收一个自己数据, 就要先发送一个字节数据
4. 读操作看起来像是写数据, 但实际上, 写入完成后, 就可以获得从机的应答数据了
5. 写入时交换来的数据是无效的，读取时写入的数据也是无效的

# 接口

SPI 接口经常被称为4线串行总线, 以主/从方式工作, 数据传输过程由主机初始化

4条信号线:

1. SCLK, Serial Clock, 串行时钟, 用来同步数据传输, 由主机输出;
2. MOSI, Master Output Slaver Input, 主机输出从机输入数据线, 写操作;
3. MISO, Master Input Slaver Output, 主机输入从机输出数据线, 读操作；
4. SS, Slave Select, 从机片选线, 低电平有效, 由主机输出;

在 SPI 总线上, 某一时刻可以出现多个从机, 但只能存在一个主机
主机通过片选线来确定要通信的从机, 要求从机的 MISO 口具有三态特性, 使得该口线在器件未被选通时表现为高阻抗
SPI 总线主要应用在 EEPROM, FLASH, 实时时钟, AD 转换器, 数字信号处理器和数字信号解码器之间, 以上均为从设备

# 数据传输

在一个SPI时钟周期内, 会完成如下操作

1. 主机通过 MOSI 线发送1位数据, 从机通过该线读取这1位数据;
2. 从机通过 MISO 线发送1位数据, 主机通过该线读取这1位数据;

移位寄存器

1. 数据传输通过移位寄存器来实现, 主机和从机各有一个移位寄存器, 且二者连接成环
2. 随着时钟脉冲, 数据按照从高位到低位的方式依次移出主机寄存器和从机寄存器, 并且依次移入从机寄存器和主机寄存器
3. 当寄存器中的内容全部移出时, 相当于完成了两个寄存器内容的交换

# 时钟极性和时钟相位

主从设备之间 SCLK 时钟要一致, 即保证时序上的一致才可正常讯

1. 时钟极性, CKPOL (Clock Polarity), 设置时钟空闲时的电平
2. 时钟相位, CKPHA (Clock Phase), 设置读取数据和发送数据的时钟沿

主机和从机的发送数据是同时完成的，两者的接收数据也是同时完成的
为了保证主从机正确通信，应使得它们的SPI具有相同的时钟极性和时钟相位。

CPOL 极性

SCLK 时钟的空闲时刻(IDLE state of SCK)就是当 SCLK 在发送8个bit数据之前和之后的状态
SCLK 在发送数据的时候, 就是正常的工作的时候, 即有效(active)的时刻

SPI的CPOL，表示当SCLK空闲idle的时候，其电平的值是低电平0还是高电平1：

CPOL=0，时钟空闲idle时候的电平是低电平，所以当SCLK有效的时候，就是高电平，就是所谓的active-high；
CPOL=1，时钟空闲idle时候的电平是高电平，所以当SCLK有效的时候，就是低电平，就是所谓的active-low；

CPHA 相位

capture strobe = latch = read = sample，都是表示数据采样，数据有效的时刻。

相位，对应着数据采样是在第几个边沿（edge），是第一个边沿还是第二个边沿，0对应着第一个边沿(Leading edge)，1对应着第二个边沿(Trailing edge)。

CPOL=0: idle时候的是低电平, 第一个边沿就是从低变到高, 第二个边沿就是从高变到低
对于CPHA=0 是上升沿时采样；
对于CPHA=1 是下降沿时采样；

CPOL=1: idle时候的是高电平, 第一个边沿就是从高变到低, 第二个边沿就是从低变到高
对于CPHA=0 是下降沿时采样；
对于CPHA=1 是上升沿时采样；

# 模式

spi四种模式SPI的相位(CPHA)和极性(CPOL)分别可以为0或1，对应的4种组合构成了SPI的4种模式(mode)

Mode 0 CPOL=0, CPHA=0
Mode 1 CPOL=0, CPHA=1
Mode 2 CPOL=1, CPHA=0
Mode 3 CPOL=1, CPHA=1	// 空闲时为高电平, 时钟上升沿时采样

时钟极性CPOL: 即SPI空闲时，时钟信号SCLK的电平（1:空闲时高电平; 0:空闲时低电平）
时钟相位CPHA: 即SPI在SCLK第几个边沿开始采样（0:第一个边沿开始; 1:第二个边沿开始）

sd 卡的 spi 常用的是 mode 0 和 mode 3, 这两种模式的相同的地方是都在时钟上升沿采样传输数据，区别这两种方式的简单方法就是看空闲时，时钟的电平状态，低电平为mode 0 ，高电平为mode 3。.

# 参考

1. [linux基础之spi驱动程序理解](http://blog.csdn.net/xqmoo8/article/details/8043474)
2. [弄懂SPI接口](http://blog.csdn.net/bytxl/article/details/50324427)
3. [如何弄懂SPI接口？看这个你就知道了](http://www.360doc.com/content/15/1203/07/908538_517544358.shtml)
4. [SPI读写总结-FreedomXura-ChinaUnix博客](http://blog.chinaunix.net/uid-20788517-id-3031990.html)
