# 基础

1. KDS 生成的程序文件是在 debug 目录下的 bin 文件，下载时名称无所谓
2. 电流互感器量程1100A
3. 相间故障由采集单元判定
4. 接地故障时，接地相电场变低，检测零序电流，由汇集单元进行录播上报主站进行判定

采集单元

1. 从调试板的 USB 接口来接采集单元的控制台
2. 采集单元主板上，Vcap 端子短接到 2.6V+ 端子，Vcap 供电到 2.6V+, 这样 JLINK 可以给采集单元供电
3. 用 SEGGER J-LINK 工具给采集单元下载 bootloader 程序, 通过短接子复位，运行起来后指示灯会慢速闪烁，无法继续用此工具下载应用程序，因为一擦除就全擦掉了
4. 用 KFlashTool 工具给采集单元下载应用程序，波特率设置为115200，短接JP5端子的两头，进入 ROM Bootloader 模式, 此时可通过串口下载应用程序
5. 拔掉JP5，复位，此时采集单元开始正常运行

1. 唯一的掉电保持的那个时钟寄存器决定了采集单元运行在 bootloader 维护模式还是工作模式
2. 先让采集单元进入 bootloader 模式才能给它下载应用程序，然后再进入工作模式
3. 采集单元在正常运行的时候即可下载 bootloader 程序
4. 采集单元收到进入bootloader模式命令后，本质上要经过重启才能进入维护模式

1. 和终端维护工具进行101串口通信的波特率是9600，无校验
2. 和控制台串口通信的波特率是115200

1. 采集单元和汇集单元本身都具有芯片自带的 ROM bootloader 程序
2. 采集单元需要远程下载程序，所以需要一个自定义的 bootloader 程序，定义一些下载命令，本质是 flash 的读写
3. 汇集单元用内部的 ROM bootloader即可

1. 采集单元复位短接子：在 JTAG 右前方三个针中间的那两个
2. 控制台串口和101通信串口不同时用的短接子，在 JTAG 左前方，拔掉

Bootloader 等待升级状态转到运行状态

1. 等待升级状态(指示灯常亮)即 Bootloader 模式(指示灯快闪)，运行状态时慢闪
2. 有电时，短接J5，复位，断开，再复位，等看门狗8s超时后会重启
3. 用简易下载器重启也应该能恢复运行状态
4. 断电重启也可以
5. U命令也行

# 4G

1. 4G模块平时工作在透传模式，需要偶尔发连接的测试帧（无意义的数据包），否则运营商会将连接断开，手机同理
手动录波，遥控0
校正
整定

# Flash

1. micron 公司的 N25Q 系列 Serial NOR Flash, 用的是8MB的
2. 4KB一个扇区 sector，128个扇区, 共512KB, 来存储录波数据
3. 小端存储模式, 高位在后

汇集单元flash存储空间分配

1. 未知

采集单元flash存储空间分配

1. flash从低地址到高地址，依次是 bootloader，应用程序，用户参数，设备参数

# RTC

1. 外部RTC模块8025, 由纽扣电池供电
2. 上电后将8025模块的时间读取到内部RTC
3. 提供32768Hz的方波的时钟源，给内部RTC提供动力来计时，平时还是通过内部RTC读取时间
4. 装置上电后等2ms看8025时钟源有没有输入，上电后8025可能没那么快运行起来，但是复位可以，改成等500ms
5. 上电流程没配8025

对时流程

1. 汇集单元上电打印 timing
2. 目前如果连接不上就会不断尝试，应该如果A在一段时间内连不上就认为A不在线，继续连B
3. 应该改成不需要3个都在线，都能对上时

# RF

1. RF可以看作无连接的对等通信
1. 采集单元和汇集单元配成组完全是靠频率来区分，1MHz就可以区分
2. 跳频，固定的几个频率，如果连接有重复的就换到另一个频率进行连接
3. 自动对频，如果一个频率上已经有连接，新连接的成套设备就不能用已有的频率

频点选择流程

1. 定义了0到5共6个频点，存入Flash

频点切换功能修改

1. 上电或复位
2. 从flash的第2000扇区读取参数到usr结构体
3. 判断读取的值是否正确，在usr结构体末尾加一个CRC校验数据成员，它的值根据前面的参数计算出来，因为flash默认全是0XFF，所以用异或来校验可能不行
4. 如果正确就进行初始化工作，如果错误，就用usr结构体定义时的默认值
5. 通过控制台命令进行频点设置时也要写入flash，只能在RF芯片的standby模式才能写入，因此可以进入操作系统的临界区，就不会被打断，调用 OSA_EnterCritical（kCriticalLockSched） 函数，禁止调度但不禁止中断，在standy，再写寄存器，再退出临界区

# KDS 快捷键

1. F5 单步调试
2. F6

并行编译
字符编码
KSDK API

快捷键 单步调试 转到定义

frame 帧
session 会话

应该先发同步帧，再发对时帧，不该一上电就循环发对时，谁在线（遥信34）才跟谁对时，一分钟必答的那个，连续几次不回就是掉线

timingflag 变量值查文档 汇集单元广播数据帧 status

JLinkRTTClient 是仿真器给调试板模拟的串口

简易下载器都是操作的采集单元

配置完参数先BL模式，再下载？

1. KDS 在调试时 debugger 的device name 写入 MKL17Z256xxx4

# KDS 操作系统组件

在os组件中设置堆空间大小
再设置函数的栈空间大小

# 简易下载器工具的使用

简易下载器通过串口与调试板进行通信，相当于调试板的操作接口，收发数据时要将调试板上的USB-RX短接子短上

1. 串口配置：配置下载器和调试板通信的串口号，调试板和采集单元无线通信的频点
2. 打开串口
3. 不能直接下载程序，因为调试板不知道跟采集单元通信的频点，要先使采集单元进入BL模式，这样下载器会顺便将调试板的频点设置成跟采集单元相同，然后再点下载给采集单元下载程序
4. 下载，重启，BL模式，操作的都是采集单元
5. BL模式按钮要按好多次，对上那个时间窗

简易下载器还可以用来抹掉程序

# 自定义控制台字符命令

O 都ABC相遥测值
P 参数配置
W 复位

打印 error:1 GPS没接天线，没有收到脉冲
打印 timing 是在对时
session.c 是链路通信程序模块

# 遗留问题

8025备用时钟没走，问张理成
configinternalrtc调试不出错断电重启出错
没有GPS模块时控制台命令无法输入
SOE和遥信变位用的时间是电脑的还是装置的

# TODO

1. 频点，存到flash再读取（参见钉钉那个表格）
2. 对时
