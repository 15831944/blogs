# iptables 语法

iptables [-t table] COMMAND chain CRETIRIA -j ACTION

| 参数        | 含义                      |
| ---------- | ------------------------- |
| [-t table] | 表格类型 filter nat mangle |
| COMMAND    | 定义如何对规则进行管理       |
| chain      | 指定你接下来的规则到底是在哪个链上操作的，当定义策略的时候，是可以省略的 |
| CRETIRIA   | 指定匹配标准               |
| -j ACTION  | 指定如何进行处理            |

举例：

```
#不允许`172.16.0.0/24`的进行访问
iptables -t filter -A INPUT -s 172.16.0.0/16 -p udp --dport 53 -j DROP
#拒绝的更彻底
iptables -t filter -R INPUT 1 -s 172.16.0.0/16 -p udp --dport 53 -j REJECT
#查看定义规则的详细信息
iptables -L -n -v
```

# COMMAND

## 1. 链管理命令

链管理命令都是立即生效的

1. -P: 设置默认策略(设定默认门是关着的还是开着的), 默认策略一般只有两种(DROP|ACCEPT)
2. -F: FLASH, 清空规则链的(注意每个链的管理权限)
3. -N: NEW,  支持用户新建一个链
4. -X: 用于删除用户自定义的空链, 使用方法跟-N相同，但是在删除之前必须要将里面的链给清空
5. -E：用来Rename chain主要是用来给用户自定义的链重命名
6. -Z：清空链，及链中默认规则的计数器的（有两个计数器，被匹配到多少个数据包，多少个字节）

## 2. 规则管理命令

1. -A：追加，在当前链的最后新增一个规则
2. -I num :插入，把当前规则插入为第几条。
3. -I 3 :插入为第三条
4. -R num：Replays替换/修改第几条规则
5. -D num：删除，明确指定删除第几条规则

## 3. 查看管理命令 “-L”

附加子命令

1. -n：以数字的方式显示ip，它会将ip直接显示出来，如果不加-n，则会将ip反向解析成主机名。
2. -v(vv)：显示详细信息, v越多越详细
3. -x：在计数器上显示精确值，不做单位换算
4. --line-numbers :显示规则的行号
5. -t nat：显示所有的关卡的信息

# 匹配标准

## 1. 通用匹配：源地址目标地址的匹配

1. -s：指定作为源地址匹配，这里不能指定主机名称，必须是IP
2. -d：表示匹配目标地址
3. -p：用于匹配协议的（这里的协议通常有3种，TCP/UDP/ICMP）
4. -i eth0：从这块网卡流入的数据流入一般用在INPUT和PREROUTING上
5. -o eth0：从这块网卡流出的数据流出一般在OUTPUT和POSTROUTING上

## 2. 扩展匹配

1. 隐含扩展：对协议的扩展
2. 显式扩展（-m）

# -j ACTION

1. DROP：悄悄丢弃, 一般我们多用DROP来隐藏我们的身份，以及隐藏我们的链表
2. REJECT：明示拒绝
3. ACCEPT：接受
4. MASQUERADE：源地址伪装
5. REDIRECT：重定向, 主要用于实现端口重定向
6. MARK：打防火墙标记的
7. RETURN：返回在自定义链执行完毕后使用返回，来返回原规则链。
