# 文件描述符概述

文件描述符概念只适用于 UNIX 操作系统, 在 windows 中使用句柄访问文件

1. 文件描述符(file descriptor): 是一个非负整型索引值, 内核(kernel)利用文件描述符来访问(读写)打开的文件或套接字(socket), 当程序打开现存文件或新建文件时, 内核会返回一个文件描述符, 因此文件描述符与打开的文件个数相对应
2. 文件描述符表: 是内核维护一个进程打开的所有文件的进程级的 u_block 数据结构, 文件描述符在该表中建立索引, 对于每个进程是唯一的, 存放于文件描述符表的一个表项
3. 文件上下文: 文件描述符与包括相关信息的文件对象相关联, 这些信息被称作文件的上下文, 如文件的打开模式, 文件的位置类型, 文件的初始类型等
4. 同一个进程可能多次打开同一个文件, 因此不同的文件描述符可能指向同一个文件
5. 不同的进程也可能打开同一个文件, 各进程的文件描述符均从0开始, 因此相同的文件描述符可能指向不同的文件

# 文件描述符常量

| Process         | descriptor | POSIX.1 unistd.h macro | standard I/O stream file pointer |
| --------------- | ---------- | ---------------------- | -------------------------------- |
| standard input  | 0          | STDIN_FILENO           | stdin                            |
| standard output | 1          | STDOUT_FILENO          | stdout                           |
| standard error  | 2          | STDERR_FILENO          | stderr                           |

# 创建文件描述符

进程获取文件描述符最常见的方法:

1. 通过本机的子例程 open 或 create 函数获取
2. 通过从父进程继承, 允许子进程能够访问由父进程使用的文件

1. 当用 fork 子例程创建某个子进程时, 该子进程会获得其父进程所有文件描述符的副本, 这些文件描述符在执行 fork 时打开
2. 在由 fcntl, dup 和 dup2 子例程复制或拷贝某个进程时, 会发生同样的复制过程

# 文件描述符硬限制

系统级限制

1. 为防止打开的文件占用过多系统内存, 一般设置最大打开文件数是系统内存的10%
2. 配置文件为 `/proc/sys/fs/file-max`
3. 用 `sysctl -a | grep fs.file-max` 命令查看查看系统级别的最大打开文件数

用户进程限制

1. 为了防止单个进程消耗掉所有的文件资源, 限制单个进程的最大打开文件数
1. 文件描述符的变化范围, 即每个进程最多可以打开 OPEN_MAX 个文件, 取值范围为 0 ~ OPEN_MAX - 1
1. 每个进程最多可以打开文件的多少取决于系统配置的存储器总量, int 的大小以及系统管理员所配置的软限制和硬限制的约束
2. 配置文件为 `/etc/security/limits.conf`, 此文件还可以针对用户设置其他资源的限制
3. 例如要设置用户 username 的一个进程可最大打开的文件数为2048, 在该文件里新增加一行：`username hard nofile 2048`, 保存该文件并退出, 该用户要重新登录系统, 设置才会生效
4. 在这里设置的数字, 不能超过系统级限制配置的数字, 即便超过也没用, 因为 file-max 里面限制了整个系统能同时打开的文件的数目
5. 用 `ulimit -n` 可查看当前用户在一个进程内可同时打开的文件数目

# 文件描述符标志

执行时关闭标志 close-on-exec, 宏名 FDCLOEXEC, 仅此一个

| value | discription                        |
| ----- | ---------------------------------- |
| 0     | exec 时不关闭已经打开的文件描述符(默认) |
| 1     | exec 时关闭已经打开的文件描述符        |

exec 函数集对文件描述符标志的影响

1. 对打开文件的处理与每个描述符的执行时关闭标志的值有关
2. 进程中每个打开描述符都有一个执行时关闭标志
3. 若此标志设置, 则在执行exec时关闭该描述符, 否则该描述符仍打开
4. 除非特地用 fcntl 设置了该标志, 否则系统的默认操作是在 exec 后仍保持这种描述符打开
5. POSIX.1 明确要求在 exec 时关闭打开目录流, 这通常是由 opendir 函数实现的, 它调用 fcntl 函数为对应于打开目录流的描述符设置执行时关闭标志

dup 函数对文件描述符标志的影响

1. 新文件描述符的执行时关闭标志总是由 dup 函数清除

fcntl 函数既能改变文件描述符标志, 也能改变文件状态标志

| command | discription     |
| ------- | --------------- |
| FGETFD  | 获取文件描述符标志 |
| FSETFD  | 设置文件描述符标志 |
| FGETFL  | 获取文件状态标志  |
| FSETFL  | 设置文件状态标志  |

# 文件描述符和文件指针的区别

1. 文件描述符: 在 linux 系统中, 打开文件就会获得文件描述符, 它是个很小的非负整数, 每个进程在 PCB(Process Control Block)中保存着一份文件描述符表, 文件描述符就是这个表的索引, 每个表项都有一个指向已打开文件的指针
2. 文件指针: C语言中使用文件指针做为 I/O 的句柄, 文件指针指向进程用户区中的 FILE 数据结构(包括一个缓冲区和一个文件描述符), 而文件描述符是文件描述符表的一个索引, 因此从某种意义上说文件指针就是句柄的句柄

# 参考

1. [文件描述符标志和文件状态标志区别](http://blog.csdn.net/hittata/article/details/8665892)
2. [每天进步一点点——Linux中的文件描述符与打开文件之间的关系](http://blog.csdn.net/cywosp/article/details/38965239)
3. [文件描述符和文件指针的区别](http://blog.chinaunix.net/uid-20672257-id-1901040.html)
