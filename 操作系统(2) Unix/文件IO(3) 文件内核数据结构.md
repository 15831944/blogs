# 文件的内核数据结构

内核空间中的3种数据结构表

系统从磁盘上打开文件读入内存时创建

一个 v 节点表项对应一个文件实体

## 1. 文件描述符表(用户进程级)

一个进程对应一张文件描述符表，因此不同进程中值相同的文件描述符可能表示不同的文件

一张文件描述符表包含:

* 文件描述符标志
* 指向文件表项的指针

## 2. 文件表项(系统级)

一个进程打开的一个文件对应一张文件表(open file table)

文件表中的各条目称为文件句柄(open file handle)

一张文件表包含:

* 文件状态标志
* 当前文件偏移量
* 指向该文件 v 节点表项的指针
* 与信号驱动相关的设置

两个不同的文件描述符，若指向同一个打开文件句柄，将共享同一文件偏移量。因此，如果通过其中一个文件描述符来修改文件偏移量（由调用read()、write()或lseek()所致），那么从另一个描述符中也会观察到变化，无论这两个文件描述符是否属于不同进程，还是同一个进程。

## 3. v 节点表项(文件系统)

v 节点表与系统无关, 因此能够在一个计算机系统上支持多个文件系统类型

v 节点包含:

* 文件类型和访问权限
* 对此文件进行各种操作的函数的指针

i 节点包含:

* 文件的所有者
* 文件长度
* 指向文件实际数据块在磁盘上所在位置的指针

## 4. 举例分析

### 1. 某一进程的不同文件描述符指向相同的文件表项

1. 某一进程调用 dup(), dup2(), fcntl() 函数

2. 某一进程对同一个文件多次调用了open()函数而形成的

### 2. 不同进程的值相同的文件描述符指向相同的文件表项

1. 调用 fork() 函数 (两个进程是父子进程关系）

2. 当某进程通过 UNIX 域套接字将一个打开的文件描述符传递给另一个进程时

3. 不同进程各自调用 open() 函数打开同一个文件，此时进程内部的描述符正好分配到该描述符值

### 3. 不同进程的不同文件描述符指向不同的文件表项但又指向相同的v节点表项

1. 不同进程各自调用 open() 函数且以不同方式打开同一个文件

# 参考

[每天进步一点点——Linux中的文件描述符与打开文件之间的关系](http://blog.csdn.net/cywosp/article/details/38965239)

[页面缓存——内存与文件的那些事儿](http://blog.csdn.net/drshenlei/article/details/4582197)
